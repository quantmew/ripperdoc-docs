---
title: Hooks
description: 用自定义 hooks 自动化工作流
---

Hooks 允许你在 Ripperdoc 生命周期的不同阶段执行自定义脚本。

## Hook 事件

| 事件 | 说明 |
|-------|-------------|
| `PreToolUse` | 工具执行前 |
| `PostToolUse` | 工具完成后 |
| `PermissionRequest` | 显示权限对话框时 |
| `UserPromptSubmit` | 用户提交消息时 |
| `Notification` | 状态通知 |
| `Stop` | 主代理完成时 |
| `SubagentStop` | 子代理（Task）完成时 |
| `PreCompact` | 上下文压缩前 |
| `SessionStart` | 会话开始或恢复时 |
| `SessionEnd` | 会话结束时 |

## 配置文件

Hooks 在以下 JSON 文件中配置（按顺序加载）：

1. `~/.ripperdoc/hooks.json` - 全局 hooks
2. `.ripperdoc/hooks.json` - 项目 hooks
3. `.ripperdoc/hooks.local.json` - 本地 hooks（已在 gitignore 中）

## 配置格式

正确的配置格式使用嵌套的事件/匹配器结构：

```json
{
  "hooks": {
    "EventName": [
      {
        "matcher": "ToolPattern",
        "hooks": [
          {
            "type": "command",
            "command": "your-command-here",
            "timeout": 60
          }
        ]
      }
    ]
  }
}
```

### 基本示例

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "echo 'Bash completed' >> /tmp/ripperdoc.log",
            "timeout": 60
          }
        ]
      }
    ]
  }
}
```

## Hook 类型

### Command Hooks

执行 shell 命令：

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "echo 'Tool completed'",
            "timeout": 60
          }
        ]
      }
    ]
  }
}
```

### Prompt Hooks

使用 LLM 处理 hook（支持 `Stop`、`SubagentStop`、`UserPromptSubmit`、`PreToolUse`、`PermissionRequest`）：

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "Review this edit for security issues: $ARGUMENTS",
            "timeout": 30
          }
        ]
      }
    ]
  }
}
```

## 匹配器（Matchers）

`matcher` 字段控制 hook 何时运行：

- **精确工具名**：`"Bash"`、`"Edit"`、`"Write"`
- **正则表达式**：`"Edit|Write"`、`"mcp__.*__write.*"`
- **匹配所有**：`"*"` 或省略 matcher 字段

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "echo 'File operation detected'"
          }
        ]
      }
    ]
  }
}
```

## Hook 输入（stdin JSON）

Hooks 通过标准输入接收 JSON 格式的上下文。所有 hooks 的公共字段：

| 字段 | 说明 |
|-------|-------------|
| `session_id` | 当前会话 ID |
| `transcript_path` | 对话 JSON 文件路径 |
| `cwd` | 当前工作目录 |
| `permission_mode` | 模式：`default`、`plan`、`acceptEdits`、`bypassPermissions` |
| `hook_event_name` | 事件名称 |

### PreToolUse/PostToolUse 输入

```json
{
  "hook_event_name": "PreToolUse",
  "session_id": "abc123",
  "cwd": "/path/to/project",
  "tool_name": "Bash",
  "tool_input": {"command": "npm test"},
  "tool_use_id": "tool_123"
}
```

### PermissionRequest 输入

```json
{
  "hook_event_name": "PermissionRequest",
  "tool_name": "Bash",
  "tool_input": {"command": "rm -rf temp"},
  "tool_use_id": "tool_456"
}
```

### UserPromptSubmit 输入

```json
{
  "hook_event_name": "UserPromptSubmit",
  "prompt": "Please fix the bug in main.py"
}
```

### Stop/SubagentStop 输入

```json
{
  "hook_event_name": "Stop",
  "stop_hook_active": false,
  "reason": "end_turn"
}
```

### PreCompact 输入

```json
{
  "hook_event_name": "PreCompact",
  "trigger": "auto",
  "custom_instructions": ""
}
```

`trigger` 字段可以是 `manual`（来自 `/compact` 命令）或 `auto`（自动压缩）。

### SessionStart 输入

```json
{
  "hook_event_name": "SessionStart",
  "source": "startup"
}
```

`source` 字段可以是：`startup`、`resume`、`clear`、`compact`。

### SessionEnd 输入

```json
{
  "hook_event_name": "SessionEnd",
  "reason": "other",
  "duration_seconds": 123.45,
  "message_count": 10
}
```

### Notification 输入

```json
{
  "hook_event_name": "Notification",
  "message": "Permission required",
  "notification_type": "permission_prompt"
}
```

通知类型：`permission_prompt`、`idle_prompt`、`auth_success`、`elicitation_dialog`。

## Hook 输出（JSON）

Hooks 可以输出 JSON 来控制执行：

```json
{
  "decision": "allow",
  "reason": "Approved by hook"
}
```

### 决策值

| 决策 | 适用事件 | 作用 |
|----------|--------|--------|
| `allow` | PreToolUse, PermissionRequest | 跳过权限检查，自动批准 |
| `deny` | PreToolUse, PermissionRequest | 阻止操作 |
| `ask` | PreToolUse | 询问用户确认 |
| `block` | PostToolUse, UserPromptSubmit, Stop, SubagentStop | 阻止/防止停止 |

### 高级输出格式

```json
{
  "continue": true,
  "stopReason": "Optional reason",
  "suppressOutput": false,
  "systemMessage": "Message to add to system prompt",
  "additionalContext": "Context to inject",
  "hookSpecificOutput": {
    "hookEventName": "PreToolUse",
    "permissionDecision": "allow",
    "permissionDecisionReason": "Auto-approved by policy",
    "updatedInput": {"command": "modified command"}
  }
}
```

### 退出码

| 退出码 | 行为 |
|-----------|----------|
| `0` | 成功。处理 stdout，如有 JSON 则解析 |
| `2` | 阻塞错误。使用 stderr 作为错误消息，忽略 JSON |
| 其他 | 非阻塞错误。向用户显示 stderr |

## 环境变量

Hooks 通过环境变量获取上下文：

| 变量 | 说明 |
|----------|-------------|
| `RIPPERDOC_PROJECT_DIR` | 项目根目录 |
| `RIPPERDOC_SESSION_ID` | 当前会话 ID |
| `RIPPERDOC_TRANSCRIPT_PATH` | 对话记录 JSON 文件路径 |
| `RIPPERDOC_ENV_FILE` | 持久化环境变量的文件路径（仅 SessionStart） |

旧版变量（已弃用但仍可用）：

| 变量 | 说明 |
|----------|-------------|
| `TOOL_NAME` | 工具名称 |
| `TOOL_INPUT` | JSON 编码的工具输入 |
| `FILE_PATH` | 文件路径（文件操作时） |
| `MESSAGE` | 通知内容 |
| `SESSION_ID` | 当前会话 ID |

## 示例

### 记录工具使用

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "echo \"[$(date)] Tool executed\" >> ~/.ripperdoc/tool.log"
          }
        ]
      }
    ]
  }
}
```

### 保护敏感文件

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"import sys, json; data=json.load(sys.stdin); path=data.get('tool_input',{}).get('file_path',''); sys.exit(2) if '.env' in path else sys.exit(0)\" 2>&1 || echo '{\"decision\": \"deny\", \"reason\": \"Cannot edit .env files\"}'"
          }
        ]
      }
    ]
  }
}
```

### 桌面通知

```json
{
  "hooks": {
    "Notification": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "jq -r '.message' | xargs -I {} notify-send 'Ripperdoc' '{}'"
          }
        ]
      }
    ]
  }
}
```

### 编辑后自动格式化

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Edit",
        "hooks": [
          {
            "type": "command",
            "command": "jq -r '.tool_input.file_path // empty' | grep '\\.py$' | xargs -r black 2>/dev/null || true"
          }
        ]
      }
    ]
  }
}
```

### 阻止代理停止

```json
{
  "hooks": {
    "Stop": [
      {
        "hooks": [
          {
            "type": "prompt",
            "prompt": "Check if the task is complete. If not, respond with {\"decision\": \"block\", \"reason\": \"Continue working on the task\"}",
            "timeout": 30
          }
        ]
      }
    ]
  }
}
```

### 会话启动时初始化环境

```json
{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "echo 'MY_VAR=value' >> \"$RIPPERDOC_ENV_FILE\""
          }
        ]
      }
    ]
  }
}
```

## 管理 Hooks

使用 `/hooks` 命令：

```
> /hooks list
> /hooks reload
```

## 最佳实践

1. **谨慎测试 hooks**：用日志排查 hook 行为
2. **保持 hooks 快速**：慢 hook 会影响响应速度（默认超时：60秒）
3. **实验使用本地 hooks**：`.ripperdoc/hooks.local.json` 已在 gitignore 中
4. **优雅处理错误**：成功退出码 0，阻塞错误退出码 2
5. **解析 stdin JSON**：使用 `jq` 或类似工具提取输入字段
6. **复杂决策使用 prompt hooks**：基于 LLM 的 hooks 可做更精细的控制
